{% load static %}
<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Grievance List</title>

  <!-- Tailwind CDN (dev) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- lucide icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <link rel="icon" href="{% static 'images/favicon.ico' %}">

  <style>
    :root{
      --bg-start: #071124;
      --bg-end:   #072f2e;
      --brand:    #0ea5a4;
      --accent:   #7c3aed;
      --muted:    #98aeb8;
      --card:     rgba(255,255,255,0.03);
      --glass-border: rgba(255,255,255,0.04);
      --text-high: #e6eef3;
    }

    html,body { height:100%; }
    body {
      background: linear-gradient(180deg,var(--bg-start),var(--bg-end));
      color: var(--text-high);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* glass card */
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid var(--glass-border);
      box-shadow: 0 8px 28px rgba(2,6,23,0.45);
      backdrop-filter: blur(6px);
    }

    /* selects readable in dark */
    .select-readable,
    select.select-readable,
    select {
      color: var(--text-high) !important;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)) !important;
      border: 1px solid rgba(255,255,255,0.05) !important;
      padding: .45rem .9rem .45rem .6rem !important;
      border-radius: .375rem !important;
      -webkit-appearance: none !important;
      -moz-appearance: none !important;
      appearance: none !important;
      outline: none !important;
      background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23e6eef3'><path d='M5.25 7.5L10 12.25 14.75 7.5z'/></svg>") !important;
      background-repeat: no-repeat !important;
      background-position: right 0.6rem center !important;
      background-size: 1rem 1rem !important;
    }
    .select-readable option { background: #05242b; color: var(--text-high) !important; }

    .search-input {
      background: rgba(255,255,255,0.03);
      color: var(--text-high);
      border: 1px solid rgba(255,255,255,0.04);
      padding: .53rem .7rem;
      border-radius: .375rem;
      outline: none;
    }
    .search-input::placeholder { color: rgba(255,255,255,0.45); }

    .btn-primary {
      background: linear-gradient(90deg, var(--brand), #0b8f8b);
      color: white;
      padding: .5rem .85rem;
      border-radius: .5rem;
      box-shadow: 0 8px 20px rgba(13,138,132,0.10);
    }
    .btn-accent {
      background: linear-gradient(90deg, var(--accent), #5b21b6);
      color: white;
      padding: .45rem .75rem;
      border-radius: .5rem;
      box-shadow: 0 8px 20px rgba(79,70,229,0.08);
    }

    .muted { color: var(--muted); }

    table th { color: var(--muted); font-weight:600; text-transform:uppercase; font-size:.72rem; letter-spacing:.06rem; }
    table tbody tr:hover { background: rgba(255,255,255,0.02); }

    .badge { padding:.25rem .5rem; border-radius:.375rem; font-size:.75rem; text-transform:capitalize; display:inline-block; }
    .b-new { background: rgba(245,158,11,0.12); color:#fbbf24; }
    .b-in_progress { background: rgba(14,165,164,0.08); color:#2dd4bf; }
    .b-resolved { background: rgba(16,185,129,0.08); color:#34d399; }
    .b-closed { background: rgba(107,114,128,0.06); color:#94a3b8; }

    /* responsive helpers for icon+text overlap fix */
    .filter-group { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    .filter-item { min-width:0; } /* so flex children shrink correctly */
    .filter-item .select-readable { min-width:10rem; }

    /* mobile toggle */
    #mobileToggle { display:none; }
    @media (max-width: 768px) {
      aside.w-72 { display:none; } /* hide large sidebar on small screens */
      #mobileToggle { display:inline-flex; }
      .mobile-sidebar { display:none; position:fixed; z-index:60; inset:0; padding:1.25rem; }
      .mobile-sidebar.open { display:block; }
    }
  </style>
</head>

<body class="min-h-screen antialiased">
  <div class="min-h-screen flex">
    <!-- SIDEBAR -->
    <aside class="w-72 p-6 hidden md:flex flex-col gap-6 glass">
      <div class="flex items-center gap-3">
        <img src="{% static 'images/favicon.ico' %}" class="w-12 h-12 rounded-lg" alt="logo">
        <div>
          <div class="font-bold text-lg">Grievance Admin</div>
          <div class="text-xs muted">Control center</div>
        </div>
      </div>

      <nav class="flex-1">
        <ul class="space-y-1">
          <li><a href="{% url 'adminpanel:dashboard' %}" class="flex items-center gap-3 px-3 py-2 rounded-md ui-transition bg-white/6 hover:bg-white/10"><i data-lucide="home" class="w-4 h-4"></i> Dashboard</a></li>
          <li><a href="{% url 'adminpanel:grievances_list' %}" class="flex items-center gap-3 px-3 py-2 rounded-md ui-transition bg-white/10"><i data-lucide="file-text" class="w-4 h-4"></i> Grievances</a></li>
          <li><a href="{% url 'adminpanel:analytics' %}" class="flex items-center gap-3 px-3 py-2 rounded-md ui-transition hover:bg-white/6"><i data-lucide="bar-chart-2" class="w-4 h-4"></i> Analytics</a></li>
          <li><a href="{% url 'adminpanel:users' %}" class="flex items-center gap-3 px-3 py-2 rounded-md ui-transition hover:bg-white/6"><i data-lucide="users" class="w-4 h-4"></i> Users</a></li>
          <li><a href="{% url 'adminpanel:categories' %}" class="flex items-center gap-3 px-3 py-2 rounded-md ui-transition hover:bg-white/6"><i data-lucide="tag" class="w-4 h-4"></i> Categories</a></li>
          <li><a href="{% url 'adminpanel:grievances_list' %}" class="flex items-center gap-3 px-3 py-2 rounded-md ui-transition hover:bg-white/6"><i data-lucide="settings" class="w-4 h-4"></i> Settings</a></li>
        </ul>
      </nav>

      <div class="text-xs muted">
        <div>Logged in as</div>
        <div class="font-medium">{{ request.user.username }}</div>
      </div>
    </aside>

    <!-- MAIN -->
    <div class="flex-1 min-h-screen flex flex-col">
      <!-- TOPBAR -->
      <header class="flex items-center justify-between px-6 py-4 glass">
        <div class="flex items-center gap-4">
          <button id="mobileToggle" class="md:hidden p-2 rounded bg-white/6 ui-transition"><i data-lucide="menu" class="w-5 h-5"></i></button>
          <div class="text-xl font-semibold">Grievances</div>
          <div class="ml-6 hidden md:flex items-center gap-3">
            <input id="topSearch" placeholder="Search grievances or users..." class="search-input text-sm w-80" />
            <button id="topSearchBtn" class="btn-primary text-sm ui-transition">Search</button>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <form method="post" action="{% url 'accounts:logout' %}" style="display:inline;">{% csrf_token %}
            <button type="submit" class="px-3 py-2 rounded bg-white/6 hover:bg-white/10">Sign out</button>
          </form>
        </div>
      </header>

      <!-- CONTENT -->
      <main class="p-6 space-y-6">
        <!-- metric row -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="p-4 rounded-xl glass flex items-center justify-between">
            <div>
              <div class="text-xs muted">Total grievances</div>
              <div id="card-total" class="text-2xl font-bold">—</div>
              <div class="text-xs muted">All time</div>
            </div>
            <div class="bg-white/4 p-3 rounded-md"><i data-lucide="list" class="w-6 h-6"></i></div>
          </div>

          <div class="p-4 rounded-xl glass flex items-center justify-between">
            <div>
              <div class="text-xs muted">Open</div>
              <div id="card-open" class="text-2xl font-bold">—</div>
              <div class="text-xs muted">New / In progress</div>
            </div>
            <div class="bg-white/4 p-3 rounded-md"><i data-lucide="clock" class="w-6 h-6"></i></div>
          </div>

          <div class="p-4 rounded-xl glass flex items-center justify-between">
            <div>
              <div class="text-xs muted">Resolved</div>
              <div id="card-resolved" class="text-2xl font-bold">—</div>
              <div class="text-xs muted">Completed</div>
            </div>
            <div class="bg-white/4 p-3 rounded-md"><i data-lucide="check-circle" class="w-6 h-6"></i></div>
          </div>

          <div class="p-4 rounded-xl glass flex items-center justify-between">
            <div>
              <div class="text-xs muted">Avg resolution (days)</div>
              <div id="card-sla" class="text-2xl font-bold">—</div>
              <div class="text-xs muted">SLA</div>
            </div>
            <div class="bg-white/4 p-3 rounded-md"><i data-lucide="trending-up" class="w-6 h-6"></i></div>
          </div>
        </div>

        <!-- top area: filters + table -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Left: table area -->
          <section class="lg:col-span-2 p-4 rounded-xl glass">
            <div class="flex items-center justify-between mb-4 gap-3">
              <div class="filter-group">
                <div class="filter-item">
                  <select id="filter-status" class="select-readable text-sm">
                    <option value="">All status</option>
                    <option value="new">New</option>
                    <option value="in_progress">In Progress</option>
                    <option value="resolved">Resolved</option>
                    <option value="closed">Closed</option>
                  </select>
                </div>

                <div class="filter-item">
                  <select id="filter-category" class="select-readable text-sm">
                    <option value="">All categories</option>
                  </select>
                </div>

                <div class="filter-item">
                  <select id="page-size" class="select-readable text-sm">
                    <option value="10">10</option>
                    <option value="25" selected>25</option>
                    <option value="50">50</option>
                  </select>
                </div>

                <div class="filter-item">
                  <button id="applyFilters" class="btn-primary ui-transition text-sm">Apply</button>
                </div>

                <div class="filter-item">
                  <button id="exportCsv" class="btn-accent ui-transition text-sm">Export CSV</button>
                </div>
              </div>

              <div class="text-sm muted">Showing <span id="page-info">Page 1</span></div>
            </div>

            <div class="overflow-auto">
              <table class="min-w-full">
                <thead>
                  <tr>
                    <th class="px-3 py-2 text-left">ID</th>
                    <th class="px-3 py-2 text-left">Title</th>
                    <th class="px-3 py-2 text-left">User</th>
                    <th class="px-3 py-2 text-left">Category</th>
                    <th class="px-3 py-2 text-left">Status</th>
                    <th class="px-3 py-2 text-left">Actions</th>
                  </tr>
                </thead>
                <tbody id="grievanceTable" class="text-sm">
                  <tr><td colspan="6" class="px-3 py-6 text-center muted">Loading grievances…</td></tr>
                </tbody>
              </table>
            </div>

            <div class="mt-3 flex items-center justify-between">
              <div class="text-sm muted">Total: <span id="total-count">—</span></div>
              <div class="flex items-center gap-2">
                <button id="prevPage" class="px-3 py-1 rounded bg-white/6">Prev</button>
                <button id="nextPage" class="px-3 py-1 rounded bg-white/6">Next</button>
              </div>
            </div>
          </section>

          <!-- Right: analytics + officers -->
          <aside class="p-4 rounded-xl glass">
            <h3 class="text-sm font-semibold mb-3">Analytics</h3>

            <div class="space-y-4">
              <div>
                <canvas id="statusChart" height="140"></canvas>
              </div>

              <div>
                <div class="text-sm muted">Top categories</div>
                <ul id="topCategories" class="mt-2 space-y-1 text-sm muted"></ul>
              </div>

              <div>
                <div class="text-sm muted">Officers</div>
                <select id="officerList" class="select-readable w-full mt-2 text-sm"></select>
                <button id="assignButton" class="mt-2 w-full btn-primary ui-transition">Assign selected officer</button>
              </div>
            </div>
          </aside>
        </div>
      </main>
    </div>
  </div>

  <!-- ASSIGN MODAL -->
  <div id="assignModal" class="fixed inset-0 flex items-center justify-center bg-black/50 hidden z-50">
    <div class="w-full max-w-md p-6 rounded-xl glass">
      <div class="flex items-center justify-between mb-3">
        <div class="font-semibold">Assign grievance</div>
        <button id="assignClose" class="px-2 py-1 rounded bg-white/6">✕</button>
      </div>
      <div id="assignInfo" class="text-sm muted mb-3">Grievance #—</div>
      <select id="assignSelect" class="w-full px-3 py-2 rounded select-readable text-sm"></select>
      <div class="mt-4 flex justify-end gap-2">
        <button id="assignCancel" class="px-3 py-2 rounded bg-white/6">Cancel</button>
        <button id="assignConfirm" class="btn-accent ui-transition">Confirm</button>
      </div>
    </div>
  </div>

<script>
/* ===========================
   CLIENT JS (clean + responsive)
   =========================== */

const API_BASE = '/adminpanel/api/';
let currentPage = 1;
let pageSize = 25;
let currentAssignTarget = null;
let officers = [];

/* helper fetch wrapper ensures credentials included */
async function fetchJSON(url, opts = {}) {
  opts.credentials = opts.credentials || 'same-origin';
  opts.headers = Object.assign({'Accept':'application/json', 'X-Requested-With':'XMLHttpRequest'}, opts.headers || {});
  const res = await fetch(url, opts);
  if (!res.ok) {
    const contentType = res.headers.get('content-type') || '';
    let text = null;
    if (contentType.includes('application/json')) {
      text = await res.json().catch(()=>null);
    } else {
      text = await res.text().catch(()=>res.statusText);
    }
    const err = new Error('API error ' + res.status);
    err.status = res.status;
    err.body = text;
    throw err;
  }
  return res.json();
}

/* normalize selects for dark theme (do once) */
(function normalizeSelects(){
  try {
    document.querySelectorAll('select').forEach(s => {
      Array.from(s.classList).filter(c=>c.startsWith('bg-')).forEach(c=>s.classList.remove(c));
      if (!s.classList.contains('select-readable')) s.classList.add('select-readable');
    });
  } catch(e){ console.warn('normalizeSelects error', e); }
})();

/* =====================
   Load Analytics & UI
   ===================== */
async function loadAnalytics() {
  try {
    const data = await fetchJSON(API_BASE + 'analytics/');
    document.getElementById('card-total').textContent = data.total_grievances ?? 0;
    document.getElementById('card-open').textContent = ((data.by_status?.new||0) + (data.by_status?.in_progress||0)) || 0;
    document.getElementById('card-resolved').textContent = (data.by_status && data.by_status.resolved) || 0;
    document.getElementById('card-sla').textContent = data.avg_resolution_days ?? '—';

    // top categories
    const topUl = document.getElementById('topCategories'); topUl.innerHTML = '';
    (data.by_category || []).slice(0,6).forEach(c => {
      const li = document.createElement('li'); li.className='text-sm'; li.textContent = `${c.name} — ${c.count}`; topUl.appendChild(li);
    });

    // populate categories dropdown (clear existing dynamic options)
    const catSel = document.getElementById('filter-category');
    Array.from(catSel.querySelectorAll('option[data-dyn]')).forEach(n=>n.remove());
    (data.by_category || []).forEach(c => {
      const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name; opt.setAttribute('data-dyn','1'); catSel.appendChild(opt);
    });
  } catch (err) {
    handleApiError(err, 'loadAnalytics');
  }
}

/* officers */
async function loadOfficers() {
  try {
    const data = await fetchJSON(API_BASE + 'user-status/');
    officers = data.officers || [];
    const sel = document.getElementById('officerList'); sel.innerHTML = '<option value="">Select officer</option>';
    const assignSel = document.getElementById('assignSelect'); assignSel.innerHTML = '<option value="">Select officer</option>';
    officers.forEach(o => {
      const opt = document.createElement('option'); opt.value = o.id; opt.textContent = o.username || o.full_name || o.email || `#${o.id}`;
      sel.appendChild(opt); assignSel.appendChild(opt.cloneNode(true));
    });
  } catch (err) {
    handleApiError(err, 'loadOfficers');
  }
}

/* build query string */
function qstring(params) {
  const parts = Object.entries(params).filter(([k,v]) => v !== undefined && v !== null && String(v) !== '');
  return parts.length ? '?' + parts.map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&') : '';
}

/* --------------------------
   Grievances - load & render
   -------------------------- */
async function loadGrievances(page=1) {
  currentPage = page;
  pageSize = parseInt(document.getElementById('page-size').value || 25);
  const params = { page, page_size: pageSize, status: document.getElementById('filter-status').value, category: document.getElementById('filter-category').value, search: document.getElementById('topSearch')?.value || '' , ordering: '-created_at' };
  const qs = qstring(params);
  try {
    const data = await fetchJSON(API_BASE + 'grievances/' + qs);
    renderTable(data);
  } catch(err) {
    handleApiError(err, 'loadGrievances', () => {
      document.getElementById('grievanceTable').innerHTML = `<tr><td colspan="6" class="px-3 py-6 text-center muted">Failed to load. Check console.</td></tr>`;
    });
  }
}

function renderTable(data) {
  const rows = Array.isArray(data) ? data : (data.results || []);
  const tbody = document.getElementById('grievanceTable'); tbody.innerHTML = '';
  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="6" class="px-3 py-6 text-center muted">No grievances found.</td></tr>`;
    document.getElementById('total-count').textContent = data.count ?? rows.length;
    return;
  }
  rows.forEach(g => {
    const tr = document.createElement('tr');
    tr.className = 'border-t border-white/6';
    tr.innerHTML = `
      <td class="px-3 py-3">${g.id}</td>
      <td class="px-3 py-3"><a href="/adminpanel/grievances/${g.id}/" class="hover:underline">${escapeHtml(g.title)}</a></td>
      <td class="px-3 py-3">${g.user?.username || g.user || '-'}</td>
      <td class="px-3 py-3">${(g.category && (g.category.name||g.category)) || '-'}</td>
      <td class="px-3 py-3"><span class="badge b-${(g.status||'').replace(/ /g,'_')}">${g.status||''}</span></td>
      <td class="px-3 py-3">
        <select data-id="${g.id}" class="status-select select-readable text-sm px-2 py-1 rounded">
          <option value="">Change status</option>
          <option value="new">New</option>
          <option value="in_progress">In Progress</option>
          <option value="resolved">Resolved</option>
          <option value="closed">Closed</option>
        </select>
        <button data-assign="${g.id}" class="ml-2 px-2 py-1 rounded btn-accent text-sm">Assign</button>
      </td>`;
    tbody.appendChild(tr);
  });

  // bind status change
  Array.from(document.querySelectorAll('.status-select')).forEach(sel => sel.addEventListener('change', async (e) => {
    const id = e.target.getAttribute('data-id'); const status = e.target.value;
    if (!status) return;
    try {
      await fetchJSON(API_BASE + `grievances/${id}/`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({status}) });
      await loadAnalytics(); await loadGrievances(currentPage);
    } catch(e){ alert('Failed to update status'); console.error(e); }
  }));

  Array.from(document.querySelectorAll('button[data-assign]')).forEach(btn => btn.addEventListener('click', (e) => {
    openAssignModal(e.target.getAttribute('data-assign'));
  }));

  document.getElementById('total-count').textContent = data.count ?? rows.length;
  document.getElementById('page-info').textContent = `Page ${currentPage} • ${data.count ?? rows.length} total`;
}

/* utility escape */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

/* chart (uses chart.js if present) */
let statusChart = null;
function renderStatusChart(labels, values){
  // lazy load Chart.js (if not loaded)
  if (typeof Chart === 'undefined') return;
  const ctx = document.getElementById('statusChart');
  if (statusChart) statusChart.destroy();
  statusChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets:[{ data: values }] }, options:{ responsive:true, plugins:{legend:{position:'bottom'}} } });
}

/* assign modal */
function openAssignModal(id){
  currentAssignTarget = id;
  document.getElementById('assignInfo').textContent = `Grievance #${id}`;
  document.getElementById('assignModal').classList.remove('hidden');
}
document.getElementById('assignCancel').addEventListener('click', ()=> document.getElementById('assignModal').classList.add('hidden'));
document.getElementById('assignClose').addEventListener('click', ()=> document.getElementById('assignModal').classList.add('hidden'));
document.addEventListener('click', (ev) => {
  if (ev.target && ev.target.id === 'assignConfirm') {
    (async ()=> {
      const uid = document.getElementById('assignSelect').value;
      if (!uid) return alert('Select officer');
      try {
        await fetchJSON(API_BASE + `grievances/${currentAssignTarget}/assign/`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({assigned_to: parseInt(uid)}) });
        document.getElementById('assignModal').classList.add('hidden');
        await loadGrievances(currentPage);
      } catch(e){ alert('Assign failed'); console.error(e); }
    })();
  }
});

/* pagination, filters, export */
document.getElementById('applyFilters').addEventListener('click', ()=> loadGrievances(1));
document.getElementById('nextPage').addEventListener('click', ()=> loadGrievances(currentPage + 1));
document.getElementById('prevPage').addEventListener('click', ()=> { if (currentPage > 1) loadGrievances(currentPage - 1); });

document.getElementById('exportCsv').addEventListener('click', async ()=> {
  const params = { page: currentPage, page_size: pageSize, status: document.getElementById('filter-status').value, category: document.getElementById('filter-category').value };
  const qs = qstring(params);
  try {
    const data = await fetchJSON(API_BASE + 'grievances/' + qs);
    const rows = (Array.isArray(data) ? data : data.results || []).map(i => ({id:i.id, title:i.title, user:i.user?.username||i.user||'', category:i.category?.name||'', status:i.status, created_at:i.created_at}));
    if (!rows.length) return alert('No data to export');
    const keys = Object.keys(rows[0]); const csv = [keys.join(',')].concat(rows.map(r=>keys.map(k=>`"${String(r[k]||'').replace(/"/g,'""')}"`).join(','))).join('\n');
    const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'grievances.csv'; a.click(); URL.revokeObjectURL(url);
  } catch(err){ handleApiError(err,'exportCsv'); }
});

/* debounce search */
function debounce(fn, wait = 400) {
  let t = null;
  return function(...args) {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), wait);
  };
}
const topSearch = document.getElementById('topSearch');
if (topSearch) {
  topSearch.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); loadGrievances(1); } });
  topSearch.addEventListener('input', debounce(() => { loadGrievances(1); }, 450));
}
const topSearchBtn = document.getElementById('topSearchBtn');
if (topSearchBtn) topSearchBtn.addEventListener('click', (e)=> { e.preventDefault(); loadGrievances(1); });

/* init */
async function init(){
  try {
    await loadAnalytics();
    await loadOfficers();
    await loadGrievances(1);
    // render chart from analytics if present
    // build status chart data
    try {
      const data = await fetchJSON(API_BASE + 'analytics/');
      const labels = Object.keys(data.by_status || {});
      const values = labels.map(l => data.by_status[l] || 0);
      renderStatusChart(labels, values);
    } catch(e){ /* ignore chart errors */ }
  } catch(e){ console.error('init', e); }
}
init();

/* ======= error handling helper ======= */
function handleApiError(err, ctx, fallback){
  console.error('API error', ctx, err);
  if (err && err.status === 401) {
    // show friendly message but do not auto-redirect during debugging
    const msg = 'Session expired or unauthorized. Please re-login.';
    document.getElementById('page-info').textContent = msg;
    // restore auto-redirect if desired:
    // setTimeout(()=>{ window.location.href = "{% url 'accounts:login' %}"; }, 900);
    return;
  }
  if (fallback) fallback();
  else showPageError('Failed to load data. Check console for details.');
}

/* small UI helper */
function showPageError(msg) {
  const box = document.getElementById('page-info');
  box.textContent = msg;
}

/* lucide icons init */
lucide.createIcons();
</script>

</body>
</html>














