{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Categories</title>

  <!-- Tailwind CDN (dev) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="icon" href="{% static 'images/favicon.ico' %}">
  <style>
    :root{
      --bg-start: #071124;
      --bg-end:   #072f2e;
      --brand:    #0ea5a4;
      --brand-dark:#0b8f8b;
      --accent:   #4f46e5;
      --text-high:#e6eef3;
      --text-muted:#a8bbc6;
    }
    html,body { height:100%; margin:0; }
    body {
      background: linear-gradient(180deg, var(--bg-start) 0%, var(--bg-end) 100%);
      color: var(--text-high);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
    }
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 8px 28px rgba(2,6,23,0.45);
      backdrop-filter: blur(6px);
      border-radius: .75rem;
    }
    .text-muted { color: var(--text-muted); }
    .text-high { color: var(--text-high); }
    .btn-primary {
      background: linear-gradient(90deg, var(--brand), var(--brand-dark));
      color: white; padding:.45rem .7rem; border-radius:.5rem; display:inline-flex; gap:.4rem; align-items:center;
    }
    .btn-danger {
      background: linear-gradient(90deg,#ef4444,#dc2626); color:#fff; padding:.45rem .7rem; border-radius:.5rem;
    }

    /* select fix */
    .select-readable, select {
      color: var(--text-high) !important;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)) !important;
      border: 1px solid rgba(255,255,255,0.06) !important;
      padding: .45rem .95rem .45rem .6rem !important;
      border-radius: .375rem !important;
      -webkit-appearance: none !important; appearance:none !important;
      background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23e6eef3'><path d='M5.25 7.5L10 12.25 14.75 7.5z'/></svg>") !important;
      background-repeat:no-repeat !important; background-position: right .75rem center !important; background-size: .9rem !important;
    }

    /* layout */
    .page { display:flex; min-height:100vh; }
    .sidebar { width:18rem; padding:1.25rem; }
    .content { flex:1; display:flex; flex-direction:column; }
    header.topbar { display:flex; align-items:center; justify-content:space-between; padding:1rem 1.25rem; border-bottom:1px solid rgba(255,255,255,0.03); }
    main.container { padding:1.25rem; overflow:auto; }

    /* table */
    table { width:100%; border-collapse:collapse; }
    th, td { padding:.75rem; text-align:left; }
    thead th { font-size:.85rem; color:var(--text-muted); border-bottom:1px solid rgba(255,255,255,0.04); }
    tbody tr:hover { background: rgba(255,255,255,0.015); }

    /* small helpers */
    .muted { color:var(--text-muted); font-size:.9rem; }
    .pill { background: rgba(255,255,255,0.03); padding:.25rem .5rem; border-radius:.375rem; color:var(--text-high); font-size:.85rem; }
    .search-input { background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); padding:.45rem .6rem; border-radius:.375rem; color:var(--text-high); }
    .small-muted { color: rgba(255,255,255,0.6); font-size:.85rem; }
    @media(max-width:1024px){ .sidebar { display:none; } }
  </style>
</head>
<body class="antialiased">

<div class="page">
  <!-- SIDEBAR -->
  <aside class="sidebar glass hidden lg:flex flex-col gap-6">
    <div class="flex items-center gap-3">
      <img src="{% static 'images/favicon.ico' %}" class="w-10 h-10 rounded" alt="logo">
      <div>
        <div class="font-bold text-lg">Grievance Admin</div>
        <div class="text-xs text-muted">Control center</div>
      </div>
    </div>

    <nav class="flex-1">
      <ul class="space-y-1">
        <li><a href="{% url 'adminpanel:dashboard' %}" class="flex items-center gap-3 px-3 py-2 rounded-md ui-transition bg-white/6 hover:bg-white/10"><i data-lucide="home" class="w-4 h-4"></i> Dashboard</a></li>
        <li><a href="{% url 'adminpanel:grievances_list' %}" class="flex items-center gap-3 px-3 py-2 rounded-md ui-transition hover:bg-white/6"><i data-lucide="file-text" class="w-4 h-4"></i> Grievances</a></li>
        <li><a href="{% url 'adminpanel:analytics' %}" class="flex items-center gap-3 px-3 py-2 rounded-md ui-transition hover:bg-white/6"><i data-lucide="bar-chart-2" class="w-4 h-4"></i> Analytics</a></li>
        <li><a href="{% url 'adminpanel:users' %}" class="flex items-center gap-3 px-3 py-2 rounded-md ui-transition hover:bg-white/6"><i data-lucide="users" class="w-4 h-4"></i> Users</a></li>
        <li><a href="{% url 'adminpanel:categories' %}" class="flex items-center gap-3 px-3 py-2 rounded-md ui-transition hover:bg-white/6"><i data-lucide="tag" class="w-4 h-4"></i> Categories</a></li>
      </ul>
    </nav>

    <div class="text-xs text-muted">
      <div>Logged in as</div>
      <div class="font-medium">{{ request.user.username }}</div>
    </div>
  </aside>

  <!-- CONTENT -->
  <div class="content">
    <header class="topbar glass">
      <div class="flex items-center gap-4">
        <div class="text-xl font-semibold">Categories</div>
        <div class="text-sm text-muted hidden md:block">Manage grievance categories</div>
      </div>

      <div class="flex items-center gap-3">
        <input id="searchBox" placeholder="Search categories..." class="search-input text-sm" />
        <button id="addBtn" class="btn-primary ui-transition text-sm"><i data-lucide="plus-circle" class="w-4 h-4"></i> Add</button>
        <form method="post" action="{% url 'accounts:logout' %}" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="px-3 py-2 rounded bg-white/6 hover:bg-white/10 text-sm">Sign out</button>
        </form>
      </div>
    </header>

    <main class="container">
      <div class="mb-4 flex items-center justify-between gap-4">
        <div class="muted">Total categories: <span id="totalCategories" class="pill">—</span></div>
      </div>

      <div class="glass p-4">
        <div class="overflow-x-auto">
          <table aria-live="polite">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Department</th>
                <th>Usage</th>
                <th class="text-right">Actions</th>
              </tr>
            </thead>
            <tbody id="categoryBody">
              <tr><td colspan="5" class="py-8 text-center text-muted">Loading categories…</td></tr>
            </tbody>
          </table>
        </div>

        <!-- pagination controls (client-side) -->
        <div class="mt-3 flex items-center justify-between">
          <div class="text-sm text-muted">Showing <span id="showingInfo">—</span></div>
          <div class="flex items-center gap-2">
            <button id="prevPage" class="px-3 py-1 rounded bg-white/6">Prev</button>
            <button id="nextPage" class="px-3 py-1 rounded bg-white/6">Next</button>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- MODALS -->
<!-- Add / Edit Modal -->
<div id="catModal" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
  <div class="w-full max-w-lg p-6 glass">
    <div class="flex items-center justify-between mb-3">
      <div id="catModalTitle" class="font-semibold">Add Category</div>
      <button id="catClose" class="px-2 py-1 rounded bg-white/6">✕</button>
    </div>

    <div class="space-y-3">
      <div>
        <label class="block text-sm text-muted mb-1">Name</label>
        <input id="catName" class="w-full select-readable" placeholder="Category name" />
      </div>

      <div>
        <label class="block text-sm text-muted mb-1">Department (optional)</label>
        <input id="catDept" class="w-full select-readable" placeholder="Department name (optional)" />
      </div>

      <div class="flex justify-end gap-2">
        <button id="catCancel" class="px-3 py-2 rounded bg-white/6">Cancel</button>
        <button id="catSave" class="btn-primary">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete confirm -->
<div id="delModal" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
  <div class="w-full max-w-md p-6 glass">
    <div class="flex items-center justify-between mb-3">
      <div class="font-semibold">Delete Category</div>
      <button id="delClose" class="px-2 py-1 rounded bg-white/6">✕</button>
    </div>
    <div class="text-sm text-muted mb-4">Are you sure you want to delete <strong id="delName">this category</strong>? This action cannot be undone. If the backend prevents deletion (category has grievances), you'll see an error message.</div>
    <div class="flex justify-end gap-2">
      <button id="delCancel" class="px-3 py-2 rounded bg-white/6">Cancel</button>
      <button id="delConfirm" class="btn-danger">Delete</button>
    </div>
  </div>
</div>

<script>
/* Categories page JS
   - Uses your API endpoints:
     GET  /adminpanel/api/categories/
     POST /adminpanel/api/categories/
     PATCH/DELETE /adminpanel/api/categories/{id}/
   - All requests use credentials: 'same-origin' to include session cookie.
*/

const API_BASE = '/adminpanel/api/categories/';
let categories = []; // full dataset
let filtered = [];
let currentPage = 1;
const pageSize = 15;
let editingId = null;

// util
function qs(obj){ const p = new URLSearchParams(obj); return p.toString() ? '?' + p.toString() : ''; }
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }
function apiFetch(url, opts={}) {
  opts.credentials = 'same-origin';
  opts.headers = Object.assign({'Accept':'application/json','X-Requested-With':'XMLHttpRequest'}, opts.headers || {});
  return fetch(url, opts).then(async res => {
    if (!res.ok) {
      const text = await res.text().catch(()=>null);
      const err = new Error('HTTP ' + res.status + (text ? ' - ' + text : ''));
      err.status = res.status;
      err.body = text;
      throw err;
    }
    return res.json().catch(()=>null);
  });
}

// load categories
async function loadCategories(){
  try {
    const data = await apiFetch(API_BASE, { method:'GET' });
    // data may be list or object; support both
    categories = Array.isArray(data) ? data : (data || []);
    filtered = categories.slice();
    currentPage = 1;
    renderTable();
    document.getElementById('totalCategories').textContent = categories.length;
  } catch (err) {
    console.error('loadCategories failed', err);
    if (err.status === 401) showPageMessage('Unauthorized — please login.');
    else showPageMessage('Failed to load categories.');
    document.getElementById('categoryBody').innerHTML = '<tr><td colspan="5" class="py-6 text-center text-muted">Failed to load categories. Check console.</td></tr>';
  }
}

function showPageMessage(msg){
  // small unobtrusive alert (console + temporary UI)
  console.warn(msg);
  // You can implement a toast here; for now console + brief text in table
  const el = document.getElementById('categoryBody');
  if (el) {
    // add small note row at top
    const note = document.createElement('tr');
    note.innerHTML = `<td colspan="5" class="py-2 text-sm text-muted">${escapeHtml(msg)}</td>`;
    el.prepend(note);
  }
}

function renderTable(){
  const tbody = document.getElementById('categoryBody');
  tbody.innerHTML = '';
  if (!filtered.length) {
    tbody.innerHTML = '<tr><td colspan="5" class="py-8 text-center text-muted">No categories found.</td></tr>';
    document.getElementById('showingInfo').textContent = '0';
    return;
  }

  const start = (currentPage-1)*pageSize;
  const end = start + pageSize;
  const pageItems = filtered.slice(start, end);
  pageItems.forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="align-top py-3">${c.id ?? '-'}</td>
      <td class="align-top py-3 font-medium">${escapeHtml(c.name || c.title || '')}</td>
      <td class="align-top py-3">${escapeHtml(c.department?.name || c.department || '-')}</td>
      <td class="align-top py-3">${(c.count !== undefined) ? c.count : '-'}</td>
      <td class="align-top py-3 text-right">
        <button data-edit="${c.id}" class="px-2 py-1 rounded bg-white/6 mr-2">Edit</button>
        <button data-del="${c.id}" class="px-2 py-1 rounded bg-white/6">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });

  const showingText = `${Math.min(start+1, filtered.length)}-${Math.min(end, filtered.length)} of ${filtered.length}`;
  document.getElementById('showingInfo').textContent = showingText;

  // wire events
  Array.from(document.querySelectorAll('button[data-edit]')).forEach(b => b.addEventListener('click', onEditClick));
  Array.from(document.querySelectorAll('button[data-del]')).forEach(b => b.addEventListener('click', onDelClick));
}

// search/filter
document.getElementById('searchBox').addEventListener('input', (e) => {
  const q = (e.target.value || '').trim().toLowerCase();
  if (!q) { filtered = categories.slice(); currentPage = 1; renderTable(); return; }
  filtered = categories.filter(c => (String(c.name||'') + ' ' + String(c.department?.name||c.department||'')).toLowerCase().includes(q));
  currentPage = 1;
  renderTable();
});

// pagination
document.getElementById('prevPage').addEventListener('click', () => {
  if (currentPage > 1) { currentPage--; renderTable(); }
});
document.getElementById('nextPage').addEventListener('click', () => {
  const maxPage = Math.ceil(filtered.length / pageSize) || 1;
  if (currentPage < maxPage) { currentPage++; renderTable(); }
});

// Add
document.getElementById('addBtn').addEventListener('click', () => {
  editingId = null;
  document.getElementById('catModalTitle').textContent = 'Add Category';
  document.getElementById('catName').value = '';
  document.getElementById('catDept').value = '';
  document.getElementById('catModal').classList.remove('hidden'); document.getElementById('catModal').classList.add('flex');
});

// modal controls
['catClose','catCancel'].forEach(id => document.getElementById(id).addEventListener('click', ()=> { document.getElementById('catModal').classList.add('hidden'); document.getElementById('catModal').classList.remove('flex'); }));

document.getElementById('catSave').addEventListener('click', async () => {
  const name = (document.getElementById('catName').value || '').trim();
  const dept = (document.getElementById('catDept').value || '').trim();
  if (!name) return alert('Name is required.');
  try {
    if (editingId) {
      // PATCH
      await apiFetch(API_BASE + editingId + '/', { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, department: dept || null }) });
      // update local list: reload
      await loadCategories();
    } else {
      // POST
      await apiFetch(API_BASE, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, department: dept || null }) });
      await loadCategories();
    }
    document.getElementById('catModal').classList.add('hidden'); document.getElementById('catModal').classList.remove('flex');
  } catch (err) {
    console.error('save category failed', err);
    if (err.status === 400) alert('Invalid input or category exists.');
    else if (err.status === 401) alert('Unauthorized. Login again.');
    else alert('Failed to save category.');
  }
});

// edit button handler
async function onEditClick(e){
  const id = e.currentTarget.getAttribute('data-edit');
  if (!id) return;
  editingId = id;
  // find item
  const item = categories.find(x => String(x.id) === String(id));
  document.getElementById('catModalTitle').textContent = 'Edit Category';
  document.getElementById('catName').value = item?.name || '';
  document.getElementById('catDept').value = (item && (item.department?.name || item.department)) || '';
  document.getElementById('catModal').classList.remove('hidden'); document.getElementById('catModal').classList.add('flex');
}

// delete
let deletingId = null;
function onDelClick(e){
  deletingId = e.currentTarget.getAttribute('data-del');
  const name = categories.find(c => String(c.id) === String(deletingId))?.name || '';
  document.getElementById('delName').textContent = name;
  document.getElementById('delModal').classList.remove('hidden'); document.getElementById('delModal').classList.add('flex');
}
['delClose','delCancel'].forEach(id => document.getElementById(id).addEventListener('click', ()=> { document.getElementById('delModal').classList.add('hidden'); document.getElementById('delModal').classList.remove('flex'); deletingId = null; }));

document.getElementById('delConfirm').addEventListener('click', async () => {
  if (!deletingId) return;
  try {
    await apiFetch(API_BASE + deletingId + '/', { method:'DELETE' });
    // reload
    await loadCategories();
    document.getElementById('delModal').classList.add('hidden'); document.getElementById('delModal').classList.remove('flex');
    deletingId = null;
  } catch (err) {
    console.error('delete failed', err);
    if (err.status === 400) alert('Cannot delete category (it may have linked grievances).');
    else if (err.status === 401) alert('Unauthorized. Login again.');
    else alert('Delete failed.');
  }
});

// init
(async function init(){
  try {
    await loadCategories();
  } catch(e){ console.error('init error', e); }
})();

</script>

<script>lucide.createIcons();</script>
</body>
</html>
